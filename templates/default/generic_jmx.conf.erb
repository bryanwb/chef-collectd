LoadPlugin "java"
TypesDB "/etc/collectd/plugins/generic_jmx_types.db"

# all this to get rid of extra quotes that the tomcat mbean passes
LoadPlugin "match_regex"
LoadPlugin "target_replace"
PreCacheChain "unquote"
<Chain "unquote">
  <Rule "unquote">
    <Match regex>
        Plugin "^GenericJMX$"
    </Match>
   <Target replace>
      PluginInstance "\"" ""
    </Target>
    <Target replace>
      TypeInstance "\"" ""
    </Target>
    <Target replace>
      PluginInstance "\\\"" ""
    </Target>
    <Target replace>
      TypeInstance "\\\"" ""
    </Target>
  </Rule>
</Chain>

<Plugin "java">
  JVMArg "-verbose:jni"
  <% if node['collectd']['install_method'] == "package" -%>
  JVMArg "-Djava.class.path=/usr/share/collectd/java/collectd-api.jar:/usr/share/collectd/java/generic-jmx.jar"
  <% else -%>
  JVMArg "-Djava.class.path=/opt/collectd/bindings/java/.libs/collectd-api.jar:/opt/collectd/bindings/java/.libs/generic-jmx.jar"
  <% end -%>
  LoadPlugin "org.collectd.java.GenericJMX"

  <Plugin "GenericJMX">

    ################
    # MBean blocks #
    ################
    <% @jmx_vals['mbeans'].each_pair do |mbean, vals| -%>
    <MBean "<%= mbean %>">
      ObjectName "<%= vals['objectname'] %>"
      <% if vals['instanceprefix'] -%>InstancePrefix "<%= vals['instanceprefix'] %>"<% end -%>
      <% if vals['instancefrom'] -%>InstanceFrom "<%= vals['instancefrom'] %>"<% end -%>
      <% vals['values'].each do |value| -%>
      <Value>
        <% value.each_pair do |key,val| -%>
          <% if key == "attributes" -%>
            <% val.each do |att| -%>
        Attribute "<%= att %>"
            <% end -%>
          <% else -%>
        <% if val == "true" || val == "false" -%><%= key + " " + val %><% else -%><%= key + ' "' + val + '"' %><% end -%>
          <% end -%>
        <% end -%>
      </Value>
      <% end -%>
    </MBean>
    <% end -%>

    #######################
    # Connection block(s) #
    #######################
    <% @jmx_vals['connections'].each_pair do |service, vals| -%>
    <Connection>
      Host "<%= node['fqdn'] %>"
      InstancePrefix "<%= service %>_"
      ServiceURL "service:jmx:rmi:///jndi/rmi://localhost:<%= vals['port'] %>/jmxrmi"
      <% vals['mbeans'].each do |mbean| -%>
      Collect "<%= mbean %>"
      <% end -%>
      User "<%= @jmx_user %>"
      Password "<%= @jmx_password %>"
    </Connection>
    <% end -%>
  </Plugin>
</Plugin>
